name: CI

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]
  workflow_dispatch:

jobs:
  unit-test-pytest:
    runs-on: ubuntu-latest

    steps:
      - name: Check-out repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt
          python -m pip install pytest pytest-cov pytest-raises pytest-randomly pytest-xdist pytest-playwright
          python -m playwright install --with-deps chromium

      - name: Run tests with coverage
        run: |
          pytest --cov=src --cov-report=xml:coverage.xml

      - name: Upload to codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./coverage.xml

  style-check:
    name: Run linter and format check (ruff)
    runs-on: ubuntu-latest
    needs: unit-test-pytest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref || github.ref_name }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install ruff
        run: |
          python -m pip install --upgrade pip
          python -m pip install ruff

      - name: Run ruff linter
        run: ruff check --fix .

      - name: Run ruff formatter
        run: ruff format .

      - name: Commit formatting changes
        uses: stefanzweifel/git-auto-commit-action@v7
        with:
          commit_message: "style: auto-format with ruff"

  validate-app:
    name: Validate Shiny app loads
    runs-on: ubuntu-latest
    needs: [unit-test-pytest, style-check]

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -r requirements.txt

      - name: Validate app
        run: |
          python -m shiny run --port 8000 src/app.py &
          APP_PID=$!
          sleep 10
          curl --fail --retry 3 --retry-delay 2 http://localhost:8000
          kill $APP_PID
